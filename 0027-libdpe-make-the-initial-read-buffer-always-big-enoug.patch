From 5c6ef128d03bad6fc3e4335935c8f5b20a4b4d51 Mon Sep 17 00:00:00 2001
From: Peter Jones <pjones@redhat.com>
Date: Fri, 5 Jun 2020 14:00:10 -0400
Subject: [PATCH 27/42] libdpe: make the initial read buffer always big enough
 for the opt header

Signed-off-by: Peter Jones <pjones@redhat.com>
---
 libdpe/pe_begin.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/libdpe/pe_begin.c b/libdpe/pe_begin.c
index 3bcc2c70c61..c6a22ab8c43 100644
--- a/libdpe/pe_begin.c
+++ b/libdpe/pe_begin.c
@@ -174,8 +174,14 @@ read_unmmapped_file(int fildes, size_t maxsize, Pe_Cmd cmd, Pe *parent)
 		struct {
 			struct mz_hdr mz;
 			struct pe_hdr pe;
+			union {
+				struct pe32_opt_hdr opt_hdr_32;
+				struct pe32plus_opt_hdr opt_hdr_64;
+			};
 		};
-		unsigned char raw[1];
+		unsigned char raw[sizeof(struct mz_hdr)
+				  + sizeof(struct pe_hdr)
+				  + sizeof(struct pe32plus_opt_hdr)];
 	} mem;
 
 	ssize_t nread = pread_retry (fildes, &mem.mz, sizeof(mem.mz), 0);
-- 
2.29.2

